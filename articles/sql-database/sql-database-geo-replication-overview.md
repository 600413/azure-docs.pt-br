<properties
	pageTitle="Replicação Geográfica Ativa para o Banco de Dados SQL do Azure"
	description="Este tópico explica a Replicação Geográfica Ativa para o Banco de Dados SQL e seus usos."
	services="sql-database"
	documentationCenter="na"
	authors="stevestein"
	manager="jhubbard"
	editor="monicar" />


<tags
	ms.service="sql-database"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="data-management"
	ms.date="03/07/2016"
	ms.author="sstein" />

# Replicação Geográfica Ativa para o Banco de Dados SQL do Azure

## Visão geral
O recurso de Replicação Geográfica Ativa implementa um mecanismo para fornecer a redundância de banco de dados na mesma região do Microsoft Azure ou em regiões diferentes (redundância geográfica). A Replicação Geográfica Ativa replica de forma assíncrona as transações confirmadas de um banco de dados para até quatro cópias do banco de dados em servidores diferentes. Quando a Replicação Geográfica Ativa é configurada, um banco de dados secundário é criado no servidor especificado. O banco de dados original se torna o banco de dados primário. O banco de dados primário replica de forma assíncrona as transações confirmadas para cada um dos bancos de dados secundários. Embora, a qualquer momento, o banco de dados secundário possa estar um pouco atrás do banco de dados primário, os dados secundários têm a garantia de sempre serem transacionalmente consistentes com as alterações confirmadas no banco de dados primário.

Um dos principais benefícios da Replicação Geográfica Ativa é que ela fornece uma solução de recuperação de desastre no nível do banco de dados com tempo de recuperação muito baixo. Ao colocar o banco de dados secundário em um servidor em uma região diferente, você adiciona resiliência máxima ao aplicativo. A redundância entre regiões habilita os aplicativos a se recuperar de uma perda permanente de um datacenter inteiro ou de partes de um datacenter, causada por desastres naturais, falhas humanas catastróficas ou crimes. A figura a seguir mostra que um exemplo de Replicação Geográfica Ativa configurada em um banco de dados Premium com um primário na região Oeste dos EUA e um secundário na região Leste dos EUA.

![Relacionamento de replicação geográfica](./media/sql-database-active-geo-replication/geo-replication-relationship.png)

Outro importante benefício é que os bancos de dados secundários são legíveis e podem ser usados para descarregar cargas de trabalho somente leitura, como trabalhos de relatórios. Se pretende usar o banco de dados secundário apenas para o balanceamento de carga, você pode criá-lo na mesma região que o primário. No entanto, isso não aumentará a resiliência do aplicativo a falhas catastróficas.

Entre outros cenários em que a Replicação Geográfica Ativa pode ser usada estão:

- **Migração de banco de dados**: você pode usar a Replicação Geográfica Ativa para migrar um banco de dados de um servidor para outro online com tempo de inatividade mínimo.
- **Atualizações de aplicativos**: você pode criar um secundário extra como uma cópia de failback durante as atualizações de aplicativos.

Para garantir a continuidade de negócios real, a adição de redundância de banco de dados entre datacenters é apenas parte da solução. A recuperação de um aplicativo (serviço) de ponta a ponta após uma falha catastrófica exige a recuperação de todos os componentes que constituem o serviço e quaisquer serviços dependentes. O software cliente (por exemplo, um navegador com um JavaScript personalizado), front-ends da Web, armazenamento e DNS são exemplos desses componentes. É fundamental que todos os componentes sejam resilientes às mesmas falhas e fiquem disponíveis dentro do RTO (objetivo de tempo de recuperação) de seu aplicativo. Portanto, você precisa identificar todos os serviços dependentes e entender as garantias e os recursos que eles fornecem. Em seguida, você deve tomar as medidas necessárias para garantir que seu serviço funcione durante o failover dos serviços dos quais ele depende. Para obter mais informações sobre como criar soluções para a recuperação de desastre, veja [Criando soluções de nuvem para a recuperação de desastre usando a Replicação Geográfica Ativa](sql-database-designing-cloud-solutions-for-disaster-recovery.md).

## Recursos da replicação geográfica ativa
O recurso de Replicação Geográfica Ativa fornece os seguintes recursos essenciais:

- **Replicação Assíncrona Automática**: você só pode criar um banco de dados secundário adicionando-o a um banco de dados existente. O secundário só pode ser criado em um servidor diferente do Banco de Dados SQL do Azure. Depois de criado, o banco de dados secundário é populado com os dados copiados do banco de dados primário. Este processo é conhecido como propagação. Depois que o banco de dados secundário for criado e propagado, as atualizações para o banco de dados primário serão replicadas de forma assíncrona para o banco de dados secundário automaticamente. Isso significa que as transações são confirmadas no banco de dados primário antes de serem replicadas para o banco de dados secundário. O Banco de Dados SQL garante que, após a conclusão da propagação, o banco de dados secundário permaneça sempre transacionalmente consistente. Para obter mais informações sobre a criação do banco de dados secundário, confira [Replicação Geográfica para o Banco de Dados SQL do Azure usando Transact-SQL](sql-database-geo-replication-transact-sql.md) e [Replicação Geográfica para o Banco de Dados SQL do Azure usando o PowerShell](sql-database-geo-replication-powershell.md). Confira [Configurar a replicação geográfica para o Banco de Dados SQL do Azure com o portal do Azure](sql-database-geo-replication-portal.md) para obter detalhes sobre a criação do banco de dados secundário usando o Portal do Azure.

- **Vários bancos de dados secundários**: dois ou mais bancos de dados secundários aumentam a redundância e o nível de proteção para o banco de dados primário e o aplicativo. Se existirem vários bancos de dados secundários, o aplicativo permanecerá protegido mesmo se houver uma falha em um dos bancos de dados secundários. Se houver apenas um banco de dados secundário e ele falhar, o aplicativo será exposto a um risco maior até que um novo banco de dados secundário seja criado.

- **Bancos de dados secundários legíveis**: um aplicativo pode acessar um banco de dados secundário para operações somente leitura usando as mesmas entidades de segurança usadas para acessar o banco de dados primário, ou outras. Os bancos de dados secundários operam no modo de isolamento de instantâneo para garantir que a replicação das atualizações do primário (repetição de log) não seja atrasada por consultas executadas no secundário.

>[AZURE.NOTE] A repetição de log será atrasada no secundário se houver atualizações de esquema que ele esteja recebendo do Primário, pois isso requer um bloqueio de esquema no banco de dados secundário.

- **Replicação Geográfica Ativa de bancos de dados do pool elástico**: a replicação geográfica pode ser configurada para qualquer banco de dados em um pool de banco de dados elástico Premium. O banco de dados secundário pode estar em outro pool de banco de dados elástico Premium. Para bancos de dados regulares, o secundário pode ser um pool de banco de dados elástico e vice-versa, contanto que as camadas de serviço sejam as mesmas. Para obter detalhes sobre como configurar a replicação geográfica para bancos de dados de pool elástico, confira [Replicação Geográfica para o Banco de Dados SQL do Azure usando Transact-SQL](sql-database-geo-replication-transact-sql.md) e [Replicação Geográfica para o Banco de Dados SQL do Azure usando o PowerShell](sql-database-geo-replication-powershell.md).  

- **Nível de desempenho configurável do banco de dados secundário**: um banco de dados secundário pode ser criado com um nível de desempenho menor do que o do primário. Os bancos de dados primário e secundário devem ter a mesma camada de serviço. Essa opção não é recomendada para aplicativos com elvada atividade de gravação de banco de dados, pois isso pode resultar em um maior retardo de replicação e, assim, existe um alto risco de perda de dados substancial após o failover. Além disso, após o failover, o desempenho do aplicativo será afetado até que o novo primário seja atualizado para um nível mais alto de desempenho. O gráfico de percentual de E/S de log no Portal do Azure fornece uma boa maneira de estimar o nível mínimo de desempenho do secundário que será necessário para sustentar a carga de replicação. Por exemplo, se o banco de dados Primário for P6 (1000 DTUS) e seu percentual de E/S de log for 50%, o secundário precisará ser pelo menos P4 (500 DTU). Você também pode recuperar os dados de E/S de log usando as exibições de banco de dados [sys.resource\_stats](https://msdn.microsoft.com/library/dn269979.aspx) ou [sys.dm\_db\_resource\_stats](https://msdn.microsoft.com/library/dn800981.aspx). Para obter mais informações sobre os níveis de desempenho do Banco de Dados SQL, confira [Opções de Banco de Dados SQL e desempenho](sql-database-service-tiers.md). Para obter detalhes sobre como configurar o nível de desempenho dos exemplos de banco de dados secundário, confira [Replicação Geográfica para o Banco de Dados SQL do Azure usando Transact-SQL](sql-database-geo-replication-transact-sql.md) e [Replicação Geográfica para o Banco de Dados SQL do Azure usando o PowerShell](sql-database-geo-replication-powershell.md).

- **Failover e failback controlados pelo usuário**: um banco de dados secundário pode ser alternado para a função primária a qualquer momento por meio de uma ação explícita do aplicativo ou do usuário. Durante uma interrupção real, deve ser usada a opção "não planejada", que promoverá imediatamente um secundário para primário. Quando o primário com falha se recuperar e estiver disponível novamente, o sistema o marcará automaticamente como um secundário e o atualizará de acordo com o novo primário. Devido à natureza assíncrona da replicação, uma pequena quantidade de dados poderá ser perdida durante failovers não planejados se o primário falhar antes de replicar as alterações mais recentes para o secundário. Quando um primário com vários secundários passar por failover, o sistema automaticamente reconfigurará as relações de replicação e vinculará os secundários restantes para o primário recém-promovido, sem a necessidade de intervenção do usuário. Depois que a interrupção que causou o failover for reduzida, poderá ser desejável retornar o aplicativo para a região primária. Para fazer isso, o comando de failover deve ser invocado com a opção "planejada". Para obter mais informações sobre como ativar o failover usando T-SQL, confira [Replicação Geográfica para o Banco de Dados SQL do Azure usando Transact-SQL](sql-database-geo-replication-transact-sql.md). Para obter mais informações como ativar o failover usando o PowerShell, confira [Replicação Geográfica para o Banco de Dados SQL do Azure usando o PowerShell](sql-database-geo-replication-powershell.md).

- **Como manter regras de firewall e credenciais em sincronia**: recomendamos o uso de [regras de firewall de banco de dados](sql-database-firewall-configure.md) para bancos de dados com replicação geográfica, de modo que essas regras possam ser replicadas com o banco de dados para garantir que todos os bancos de dados secundários tenham a mesma configuração de firewall que o primário. Isso elimina a necessidade de os clientes configurarem manualmente e manterem as regras de firewall nos servidores que hospedam os bancos de dados primários e secundários. Da mesma forma, o uso de [usuários de banco de dados independente](sql-database-manage-logins.md) para o acesso a dados garante que os bancos de dados primários e secundários sempre tenham as mesmas credenciais de usuário para que, em caso de failovers, não haja interrupções devido à incompatibilidade nos logons e senhas. Com a adição de [Azure Active Directory](../active-directory/active-directory-whatis.md), os clientes podem gerenciar o acesso do usuário aos bancos de dados primários e secundários, eliminando a necessidade de gerenciamento de credenciais em todos os bancos de dados juntos.

- **API do Gerenciador de Recursos do Azure e segurança baseada em funções**: a replicação geográfica ativa inclui um conjunto de [APIs do ARM (Azure Resource Manager)](https://msdn.microsoft.com/library/azure/mt163571.aspx) para gerenciamento, incluindo [cmdlets do PowerShell baseados no ARM](sql-database-geo-replication-powershell.md). Essas APIs exigem o uso de grupos de recursos e dão suporte a RBAC (segurança baseada em funções). Para obter mais informações sobre como implementar funções de acesso, confira [Controle de Acesso Baseado em Funções do Azure](../active-directory/role-based-access-control-configure.md).

>[AZURE.NOTE] A [API REST do Gerenciamento de Serviços SQL do Azure (clássico)](https://msdn.microsoft.com/library/azure/dn505719.aspx) e os [cmdlets do Banco de Dados SQL do Azure (clássico)](https://msdn.microsoft.com/library/azure/dn546723.aspx) têm suporte para compatibilidade com versões anteriores. No entanto, muitos dos novos recursos de replicação geográfica ativa só têm suporte na [API REST SQL do Azure](https://msdn.microsoft.com/library/azure/mt163571.aspx) e nos [cmdlets do PowerShell do Banco de Dados SQL do Azure](https://msdn.microsoft.com/library/azure/mt574084.aspx) baseados em ARM.

## Evitando a perda de dados críticos
Devido à alta latência das redes de longa distância, a cópia contínua usa um mecanismo de replicação assíncrona. Isso tornará a perda de alguns dados inevitável se ocorrer uma falha. No entanto, alguns aplicativos podem exigir nenhuma perda de dados. Para proteger essas atualizações críticas, um desenvolvedor de aplicativo pode chamar o procedimento de sistema [sp\_wait\_for\_database\_copy\_sync](https://msdn.microsoft.com/library/dn467644.aspx) imediatamente após a confirmação da transação. Chamar **sp\_wait\_for\_database\_copy\_sync** bloqueia o thread de chamada até que a última transação confirmada seja replicada para o banco de dados secundário. O procedimento aguardará até que todas as transações na fila tenham sido confirmadas pelo banco de dados secundário . **sp\_wait\_for\_database\_copy\_sync** é delimitado para um link de cópia contínua específica. Qualquer usuário com os direitos de conexão para o banco de dados primário pode chamar este procedimento.

>[AZURE.NOTE] O atraso causado por uma chamada de procedimento **sp\_wait\_for\_database\_copy\_sync** pode ser significativo. O atraso dependerá do tamanho do comprimento de log de transação no momento e não retornará até que o log inteiro seja replicado. Evite chamar esse procedimento, a menos que seja absolutamente necessário.

## Próximas etapas
Para obter informações sobre recursos adicionais de continuidade dos negócios do Banco de Dados SQL, confira [Visão geral da continuidade dos negócios](sql-database-business-continuity.md).

<!---HONumber=AcomDC_0413_2016-->